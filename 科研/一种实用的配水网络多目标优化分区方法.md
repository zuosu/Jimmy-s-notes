# 一种实用的配水网络多目标优化分区方法
近年来，配水网络 (WDN) 中的漏水问题引起了越来越多的关注，重点是能源和水资源。水网分区作为流量监测和泄漏控制的措施之一，是我国的研究热点。本文首先介绍了现有的分区方法，在综合考虑水力学，水质和经济性的基础上，提出了一种多目标优化分区方法。该方法基于非支配排序遗传算法 (nsga-Ⅱ)，该算法是一种用于多目标优化以获得最优方案的启发式算法。此外，在优化过程中还考虑了人的经验。在案例研究中，该方法被证明可以有效地产生良好的结果，而对wdn的水力和水质影响很小，并且所获得的结果对于多个目标都是可以接受的。因此，该方法为未来配水网络线性化的改造提供了参考。

本文将WNS视为多目标优化过程，提出了一种利用图论和nsga-Ⅱ(非支配排序遗传算法) 结合自然边界和行政边界的实用配水扇区化方法。整体框架如下 :
1. 首先考虑目标和制约因素。
2. 然后，基于讨论的目标和约束条件，提出了该方法的优化过程，在此过程中需要设置三个参数，并且还需要定义主管。本文还提出了参数的推荐值以及在考虑自然边界和行政边界的同时定义主管的方法。
3.  接下来，将该方法应用于实际案例，以证明该方法的可行性，并对分门化后在不同情况下获得的结果进行了比较和讨论。
4. 最后，本文根据所取得的结果和实际应用的意义进行了总结，并讨论了该方法的不足之处。


通常，WNS通过安装阀门和流量计将节点和管道分为几组，将wdn划分为多个扇区。换句话用数学表达，WNS在满足约束条件的同时，**寻求管道条件 (打开或关闭) 和优化目标函数的最佳组合**。如前所述，多目标优化是解决扇区化问题的一种适当方法，因为它可以实现考虑多个目标并同时获得一系列结果的目标。多目标优化获得Pareto前沿，其中包含一组Pareto最优解 (Hajebi等，2016)。非支配排序遗传算法 (nsga-Ⅱ) 采用快速非支配排序，根据个体的非劣解水平对种群进行分层。这种方法在运行速度和收敛性方面具有优势。因此，nsga-Ⅱ被用作该方法中的优化算法。下图显示了所提出方法的总体框架。

<div align = center><img src =https://files.mdnice.com/user/25190/a0b8566c-1ca0-4602-8d63-2fc2b29bcd5d.png width = "50%"></div>

## 目标函数

1. 最小化平均压力
管网压力应以平均压力$P_{avg}$为特征，即水力模拟最后24小时内所有节点的平均压力。
$$
\min P = \frac{\sum_{i = 1}^{N} \sum_{t = T-23}^{T} P_{i}^{t} / 24}{N}\tag{1}
$$
其中$P_i^t$是指节点$i$在$t$时刻的压力，$T$是水力模拟的总小时数，N是节点数。

2. 最小化平均水龄
$WA_{avg}$以水力模拟的最后24小时内的平均年龄特征来描述。
$$
\min W A=\frac{\sum_{i=1}^{N} \sum_{t=T-23}^{T} w a_{i}^{t} / 24}{N}\tag{2}
$$
其中$wa_i^t$是节点i在t时刻的的水龄，T是水力模拟的总小时数，N是节点总数。

3. 最小化改造成本
改造成本以$C$来表示
$$
\min C=\sum_{n_{m}=1}^{K_{\text {meter }}} C_{n_{m}}^{\text {meter }}+\sum_{n_{v}=1}^{K_{\text {valve }}} C_{n_{v}}^{\text {valve }}\tag{3}
$$
其中$C_{n_m}^{meter}$是流量计$n_m$的单价，$C_{n_v}^{valve}$是阀门$n_v$的单价，$K_{meter}$是流量计的总数，$K_{valve}$是阀门的总数。

4. 最大化扇区数量
最大化扇区数量的目标函数与最小化转换成本的另一个目标函数之间似乎存在冲突，但是这个问题可以很好地理解。一方面，更多的行业将增加转型成本; 另一方面，降低了每个部门的转型成本，有利于分阶段向行业转型。此外，扇区规模趋向于最大规模，并且当仅考虑转换成本时，这些分区方案将导致可能的扇区数量很少，并且将是相似的。因此，这两个目标是不可或缺的，并且相互制约。因此，目标是最大化扇区的数量，以获得具有合适的扇区数量和低成本的方案。
$$
max N\tag{4}
$$
## 决策变量

关于WNS问题，边界是指跨越两个扇区的多个管道，即开始节点和结束节点位于不同扇区的管道。如果边界中的这些管道都严格封闭，则部门之间将不会建立液压连接，这会干扰WDN中的供水。结果，这些管道中的一些需要打开以输送水，而另一些则保持关闭以减少不同部门之间的水力连接。同时，为了监控每个部门的流量，流量计应安装在边界处的那些开放管道中。相应地，阀门安装在封闭的管道中。
因此，要解决WNS问题，这项工作中的决策变量是边界管道 (打开或关闭) 的条件。数学表达式如式 (5) 所示:
$$
\forall \text { pipe }_{i} \in \text { boundarypipes, } \boldsymbol{x}(i) \in\{0,1\}\tag{5}
$$

其中boundarypipes是边界中管道的集合，i是boundarypipes中的索引，x(i) 是管道条件。如果管道i关闭，x(i) 等于0，如果管道i打开，则等于1。

## 约束条件
要使方法和结果合理，必须满足本文考虑的以下约束条件：
1. 扇区的隔离: 任意两个扇区之间不存在节点和管道的交集
$$
\forall I, J \in\{1, \ldots, k\}, \text { nodes }_{I} \cap \text { nodes }_{J}=\varnothing, \text { pipes }_{I} \cap \text { pipes }_{J}=\varnothing
\tag{6}$$
其中I，J表示两个不同的扇区； k表示扇区的数量；nodesI和pipesI分别表示扇区I中的所有节点和管道。

2. 与水源的连通性: 必须至少有一条路径才能将水输送到各个部门
$$
 \forall I \in\{1, \ldots, k\}, \forall u \in  nodes  _{I}, \exists \ s \in  sources,  \exists \ pipes \ transport\  water \ from \  s \ to \ u \tag{7} 
$$
其中I表示来自k个扇区的扇区，nodesI表示扇区I中的所有节点，而sources表示所有水源。

3. 扇区大小: 扇区大小必须介于最大大小 (maxSize) 和最小大小 (minSize) 之间
$$
\operatorname{minSize}<\operatorname{size}\left(\mathrm{DMA}_{I}\right)<maxSize \tag{8}
$$

4. 水力约束: 必须保证质量守恒和能量守恒，如公式 (9) 和公式 (10) 所示
$$
-\sum q_{i n}+\sum q_{\text {out }}+Q_{i}=0\tag{9}
$$
$$
H_{F j}-H_{T j}=h_{j}\tag{10}
$$
其中$q_{in}$，$q_{out}$分别表示流入和流出节点i的流量；$Q_i$表示节点$i$的需求； F，T分别表示管道$j$的开始节点和结束节点; $H_{Fj}，H_{Tj}$分别表示节点F，T的总和；$h_j$表示管道 $j$ 的水头损失。

5. 压力约束: 所有节点的压力必须高于最小节点压力
$$
P_{i} \geq P_{\min }\tag{11}
$$
其中$P_i$表示节点i的压力，$P_{min}$表示最小节点压力。最小节点压力通常根据当地法规确定。

6. 水厂的供水能力: 对于具有多个水源的WDN，水厂的供水在分区后可能会发生变化，并且应在水厂的最大供水能力和最小供水能力之间
$$
Q_{s, \min } \leq Q_{s} \leq Q_{s, \max }\tag{12}
$$
其中$Q_{s,min}，Q_{s}，Q_{s,max}$分别表示自来水厂的最小，实际和最大供水能力。
## 求解过程
1. 设置参数并定义主管道
* 要求设置的参数有：分区的最大大小 $maxSize$、最小大小$minSize$与节点最小压力$P_{min}$。**在论文的方法中设置$maxSize=5000$、$minSize=500$。**
* 对于主管道的选取论文中提出应包括边界附近的管道，如包括自然边界和行政区划。但是以网络N2来作为研究，因为其只有网络的拓扑结构可用，所以**主管道由直径**选择。

2. 生成第一个个体的染色体
此方法中个体的染色体由一系列二进制数表示，包括**起始方案、控制级别和扇区之间连接管道的直径级别**。
3. 通过最短路径的方法将各节点分组
使用Dijkstra算法，根据最短路径的最优子结构属性，即最短路径的一部分仍然是最短路径，因此，当某个节点i分配给某个起始k时，最短路径中的所有节点仍然分配给起始k，从而达到将节点分组的目的。
$$
\text { distance }_{k i}=\sum w_{l}, l \in\left\{\text { path }_{k i}\right\}\tag{13}
$$
其中$\{path_{ki}\}$是从开始k到节点i的最短路径中的管道集合，并且给定$l ∈\{path_{ki}\}$，$w_l$是管道$l$的权重，以管道阻力系数来表示。
$$
w_{l}=10.67 C_{l}{ }^{-1.852} d_{l}^{-4.871} L_{l} l=1,2, \ldots, M\tag{14}
$$
其中，给定$l ∈{path_{ki}}$，$C_l$是管道$l$的Hazen-Williams粗糙度系数，$dl$是管道$l$的直径，$L_l$是管道 $l$ 的长度。
对于给定的节点$i$，最佳供水路径不仅应考虑从开始到节点的供水路径，还应考虑从水源到开始的供水路径$distance_{s k}$。然后，用$distance_{sk}$和$totalDistances_{ki}$对起始$k$到节点$i$的最优供水路径进行校正，表示从水源s到起始k的经校正的最短路径，根据公式 (15) 计算。
$$
totalDistances  _{k i}=  distance  _{s k}+  distance  _{k i} \tag{15}
$$
最后，得到从某个节点$i$到$K_{selected}$ 个初始点的一组最优供水路径，如式 (16) 所示:
$$
totalDistances  _{i}=\left\{\right.  totalDistance  _{1 i}, \ldots , totalDistance  _{k i}, \ldots , totalDistance  \left._{k_{\text {selcted }} i}\right\} \tag{16}
$$
根据上述距离集，$totalDistances_{ki}$是$totaldistance_i$的最小值，这意味着节点$i$被分配到起始$k$。重复此过程，直到所有节点都被分组到选定的起始。WDN被划分为$K_{selected}$的扇区后，这些扇区的大小是不同的，有些扇区过小，需要合并这些扇区，以便扇区的规模趋于平衡。
___
[Dijkstra算法](https://www.cnblogs.com/goldsunshine/p/12978305.html)
> Dijkstra也叫迪杰斯特拉，是典型最短路径算法，计算一个起始节点到路径中其他所有节点的最短路径的算法和思想。**dijkstra的算法思想**是从最短距离数组中每次选择一个最近的点，将其作为下一个点，然后重新计算从起始点经过该点到其他所有点的距离，更新最短距离数据。已经选取过的点就是确定了最短路径的点，不再参与下一次计算。
___
4. 通过计算小扇区的控制大小来合并它们
论文中采用控制级别（ControlLevel）的方法来计算控制大小（ControlSize）。如果两个扇区的大小之和超过了控制大小则不被合并，否则对其进行合并。
$$
\text { controlSize }=\text { minSize }+(\text { maxSize }-\text { minSize }) \times \frac{\text { controlLevel }}{7}
$$
将controlLevel设置为三位二进制数，转化为十进制时它的最大值为7合并前与合并后的结果如下图所示。
<div align = center><img src = https://files.mdnice.com/user/25190/be4533c9-faa4-42df-a321-1f58831ec8dc.png width="62%"></div>

5. 优化扇区之间的连接管道
本文提出了一种简化方法。根据管道直径对连接管道进行分类，并且管道在同一直径类中的状态由二进制代码表示。例如，假设一个扇区包含DN200、DN300和DN400三个直径的管道类，则使用三位二进制代码。代码 “010” 表示DN300的管道类别保持打开，而其他类别保持关闭。
6. 计算目标、非主导排序和周期
利用EPANET对分区管网水力模型进行仿真，研究了分区后的性能。非支配排序是基于每个人的目标值以及是否违反约束。
* 目标价值高的个体被价值低的个体所支配;
* 违反约束的个体被任何不违反约束的个体所支配。

根据个体的非优势水平从最高到最低选择个体，直到个体数量超过种群规模。父代$P_1$通过选择、交叉和突变获得下一个代$Q_1$，重复3-6的步骤，直到满足算法的终止条件，得到代$P_t$。生成$P_t$是pareto最优解或近似最优解的序列。

7. 对得到的染色体代码进行解码
通过使用NSGA-II进行多目标优化，获得了一系列Pareto最优解。根据2-5步骤中的编码规则对其进行解码，得到每个方案的基本信息。包括开始，控制级别和连接管道优化。接下来，通过执行液压和水质模拟 (EPANET)，可以获得扇区化的详细信息，例如扇区，目标以及流量计和阀门的数量。解决方案中的每个人都代表一种用于配水网络部门化的方案。
___
NSGA（非支配排序遗传算法）、NSGAII（带精英策略的非支配排序的遗传算法），都是基于遗传算法的多目标优化算法，都是基于pareto最优解讨论的多目标优化。
* Paerot支配关系
<div align = center><img src = https://files.mdnice.com/user/25190/22e409f3-be5c-41a4-8772-8deb805c20de.png ></div>
<div align = center><img src = https://files.mdnice.com/user/25190/98c21ca1-a156-499c-a629-8a445031c693.png></div>

* Pareto最优解定义
多目标优化问题与单目标优化问题有很大差异。当只有一个目标函数时,人们寻找最好的解,这个解优于其他所有解，通常是全局最大或最小，即全局最优解。而当存在多个目标时，由于目标之间存在冲突无法比较，所以很难找到一个解使得所有的目标函数同时最优，也就是说，一个解可能对于某个目标函数是最好的，但对于其他的目标函数却不是最好的，甚至是最差的。因此，对于多目标优化问题，通常存在一个解集，这些解之间就全体目标函数而言是无法比较优劣的，其特点是：无法在改进任何目标函数的同时不削弱至少一个其他目标函数。这种解称作非支配解(nondominated soluitons)或Pareto最优解(Pareto optimal Soluitons)，定义如下：
<div align = center><img src = https://files.mdnice.com/user/25190/f3d89e57-70bb-40f6-86dd-b3daa56a1a06.png></div>

>** NSGA（非支配排序遗传算法）**
> NSGA采用的非支配分层方法,可以使好的个体有更大的机会遗传到下一代；适应度共享策略则使得准Pareto面上的个体均匀分布，保持了群体多样性，克服了超级个体的过度繁殖，防止了早熟收敛。流程图如下：
> <div align=center><img src = https://files.mdnice.com/user/25190/9bad5d12-fee1-49a0-92ad-16e7a2ae1a3d.png width = "56%"></div>
> 
>NSGA与简单的遗传算法的主要区别在于：该算法在选择算子执行之前根据个体之间的支配关系进行了分层。其选择算子、交叉算子和变异算子与简单遗传算法没有区别。
从图中可以看到，算法首先判断种群是否全部分级，如果已经全部分级，则在分级的基础上，使用基于拥挤策略的小生境(NIChe)技术对虚拟适应度值进行调整，并确定每个种群的虚拟适应度值，然后根据虚拟适应度值的大小，确定优先选择进行处理的种群（遗传算法）。
> **非支配排序**
> 考虑一个目标函数个数为K(K>1)、规模大小为N的种群,通过非支配排序算法可以对该种群进行分层,具体的步骤如下:
> 1. 设 $j$=1
>2. 对于所$g=1,2,\cdots,N$，且$g\neq j$，基于适应度函数比较个体$x^{j}$和个体$x^g$之间的支配与非支配关系
>3. 如果不存在任何一个个体$x^g$优于$x^j$，则$x^j$标记为非支配个体；
>4. 令$j=j+1$，转到步骤1，直到找到所有非支配个体
>通过上述步骤得到的非支配个体集是种群的第一级非支配层;然后，忽略这些标记的非支配个体，再遵循步骤(1)一(4)，就会得到第二级非支配；依此类推，直到整个种群被分类。


> **虚拟适应度的确定**
>在对种群进行非支配排序的过程中，需要给每一个非支配层指定一个虚拟适应度值。级数越大，虚拟适应度值越小；反之,虚拟适应度值越大。这样可以保证在选择操作中等级较低的非支配个体有更多的机会被选择进入下一代，使得算法以最快的速度收敛于最优区域。另一方面，为了得到分布均匀的Pareto最优解集，就要保证当前非支配层上的个体具有多样性。NSGA中引入了基于拥挤策略的小生境(NIChe)技术，即通过适应度共享函数的方法对原先指定的虚拟适应度值进行重新指定。
><div align=center><img src = https://files.mdnice.com/user/25190/2bbd675e-c124-4a11-b90b-e0effd79d3d6.png></div>
><div align=center><img src = https://files.mdnice.com/user/25190/dfdb7561-776d-4383-8c7b-9e064d7af329.png></div>

>* NSGAII算法
>NSGA一II算法的基本思想为：首先，随机产生规模为N的初始种群，非支配排序后通过遗传算法的选择、交叉、变异三个基本操作得到第一代子代种群；其次，从第二代开始，将父代种群与子代种群合并，进行快速非支配排序，同时对每个非支配层中的个体进行拥挤度计算，根据非支配关系以及个体的拥挤度选取合适的个体组成新的父代种群；最后，通过遗传算法的基本操作产生新的子代种群；依此类推，直到满足程序结束的条件。相应的程序流程图如下图所示。
><div align=center><img src = https://files.mdnice.com/user/25190/9bc95650-77a5-4b37-a237-5dcb9995d7c8.png width = "70%"></div>

> **快速非支配排序算法**
假设种群为P，则该算法需要计算P中的每个个体p的两个参数$n_P$和$S_p$，其中$n_p$为种群中支配个体p的个体数，$S_p$为种群中被个体p支配的个体集合。遍历整个种群，这两个参数的总计算复杂度是$O(mN^2)$。
>算法的主要步骤为：
>1. 找到种群中所有$n_p=0$的个体，并保存至当前集合$F_1$中；
>2. 对于当前集合$F_1$中的每个个体$i$，其所支配的个体集合为$S_i$，遍历$S_i$中的每个个体$l$，执行$n_l=n_l-1$，如果$n_l=0$则将个体$l$保存在集合$H$中；
>3. 记$F_1$中得到的个体为第一个非支配层的个体，并以H作为当前集合，重复上述操作，直到整个种群被分级。

>** 拥挤度**
> 拥挤度是指某种群给定个体的周围个体的密度。如下图所示，以$n$个体的拥挤度举例来说，它的拥挤度是$n-1$和$n+1$构成方形的周长，长用$n_d$表示，最左边和最右边的点的拥挤度设置为无穷大。
> <div align = center><img src = https://files.mdnice.com/user/25190/cdeeba82-9647-40bd-a2a8-3f0ba4788db9.png width = "50%"></div>
> 
> 拥挤度的算法如下：
> 1. 令$n_d=0,n=1,2,\cdots,N$
> 2. 对于每个目标函数
> 	1. 基于该目标函数对种群进行排序
> 	2. 令边界的两个个体拥挤度为无穷，即$1_d=N_d=\infty$
> 	3. 计算$n_d = n_d+(f_m(i+1)-f_m(i-1)),n=2,3,\cdots,N-1$

> **拥挤度比较算子**
> 通过快速非支配排序以及用激素计算之后，种群中的每个个体$n$都得到两个属性：非支配序$n_{rank}$和拥挤度$n_d$。利用这两个属性，可以区分种群中任意两个个体的支配和非支配关系。定义拥挤度比较算子为$\geq_n$，个体优势的比较依据为$i\geq_n j$，即个体$i$优于个体$j$，当且仅当$i_{rank}<j_{rank}$或$i_{rank}=j_{rank}$且$i_d>j_d$


> **两种算法对比及II代的改进**
> 非支配排序遗传算法(NSGA)在许多问题上得到了应用,但NSGA仍存在一些问题:  
>* 计算复杂度较高，为O(mN3)(m为目标函数个数，N为种群大小)，所以当种群较大时，计算相当耗时。  
>* 没有精英策略，精英策略可以加速算法的执行速度,而且也能在一定程度上确保己经找到的满意解不被丢失。  
>* 需要指定共享半径。
>
> 而NSGA一II针对以上的缺陷通过以下三个方面进行了改进:
>* 提出了快速非支配排序法，降低了算法的计算复杂度。由原来的O(mN3)降到O(mN2),其中，m为目标函数个数,N为种群大小。  
>* 提出了拥挤度和拥挤度比较算子，代替了需要指定共享半径的适应度共享策略，并在快速排序后的同级比较中作为胜出标准，使准Paroet域中的个体能扩展到整个Pareto域，并均匀分布，保持了种群的多样性。  
>* 引入精英策略,扩大采样空间。将父代种群与其产生的子代种群组合，共同竞争产生下一代种群，有利于保持父代中的优良个体进入下一代，并通过对种群中所有个体的分层存放，使得最佳个体不会丢失，迅速提高种群水平。
___
## 结果与讨论
优化后，获得了35个唯一的解。35个解决方案分布在四维表面上。由于这些答案中的平均压力或平均水龄存在小的变化，因此从其余三个目标中得出两个三维表面，从而分别忽略平均压力和平均水龄的影响，如下图所示。
<div align = center><img src = https://files.mdnice.com/user/25190/85b933cc-7349-4268-a4a7-9e5e3c5c2997.png></div>

根据扇区的数量，将35个唯一解按升序排序。四个目标的变化如图7所示，这表明随着扇区数量的增加总体而言，平均压力趋于减少，而转型成本趋于增加。
<div align = center ><img src = https://files.mdnice.com/user/25190/bcfc69c6-d047-46af-a9bf-82c329f5b123.png></div>
平均水龄与平均压力几乎相反。35个解决方案的扇区数量为11-26个。平均压力和平均水龄的变化很小，因为平均压力在25.24至26.59 m之间，而平均水龄在40.70至42.78 h之间。改造成本在0.91-2.2万元之间。流量计数量的最小和最大值分别为36和92，阀门的最小和最大值分别为1和28。图8显示了具有不同最佳目标的四个选定的扇区化结果，表2显示了来自这些结果的目标的详细信息。

<div align = center><img src = https://files.mdnice.com/user/25190/13b0e229-f8f2-4ea5-a4cf-fd0c6235bd9e.png width = "90%"></div>

<div align = center><img src = https://files.mdnice.com/user/25190/ebc76940-354c-4174-9497-4369062aa44e.png width = "50%"></div>

最后通过对比没有人工选择主管道和有选择人工主管道的分区如图11，结果发现，有人工选择主管道的情况可以使安装的流量计和阀门的数量减少，改造成本也相应降低。同时，更少的设备也更易于管理，使得流量计和阀门的安装更加方便。

<div align = center><img src = https://files.mdnice.com/user/25190/c6bf1b35-0048-4d4c-97bc-d24a495fd363.png width = "90%"></div>

通过对比没有优化连接管道和有优化连接管道的情况发现，在没有优化的情况下，平均水龄为42.43 h，而在优化后下降到41.58 h。此外，平均阀门数量从13.12个增加到30.48个，导致管网近34个端部; 也就是说，随着多安装一个阀门，将形成多两个管网端部。这可能导致管网整体水质水平下降。所以连接管的优化有助于减少平均水龄和管网末端的数量，这可能对改善水质有意义。

总的来说，该方法得到的方案为未来的配水管网分区改造提供了参考，该方法在提供可行和优化的解决方案方面突出了很好的性能。不过此方法仍有不足之处，如人工选取主管道的主观性较强。如何自动实现自然和行政边界相结合的选择主管道的目标需要进一步考虑。此外，如果分支管网在WDN中占很大比例，则获得的结果通常多样性较差。在这种情况下，结果可能需要单独调整。