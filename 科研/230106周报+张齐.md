	# 周报（时间：230106）
本周主要做的工作有：  
1. 调研了漏损检测的模型，上周提到目前的漏损检测模型大多使用软件设计，如EPANET、WaterGEM等，为了了解流量、压力的预测就去找EPANET的手册看了看，手册中提出在静态时，根据**梯度方法**利用迭代求解能量守恒方程和质量守恒方程，得出下一刻节点水头和流量；在动态（水箱、需水量变化时的长时间分析）时，为每个水箱添加动态方程，并将这些方程添加到静态网络模型中，然后根据静态时的算法进行求解（具体内容见正文）。但我没看明白这些动态方程和之前的静态网络模型有什么联系，加进去之后的模型也不知道该怎么用，即便看懂了，这个模型也不是自己想要的。
2. 因为现在就是想找到预测流量和压力的模型，根据预测值与实际测量值之间的偏差来确定是否存在漏损。迫于模型涉及水力学的知识，英文文献中的专业词汇自己翻译不好难免会产生误解，就去知网搜了一下中文的文献，发现了用卡尔曼滤波预测流量进行漏损检测的文献，可以将其中的模型拿过来用（具体内容见正文）。
## 1. EPANET中的模型[1]
### 1.1 静态网络模型（固定用水需求）
考虑一个有N个结点和NF个固定等级结点（水槽和水库）的管道网络。设$q_{ij}$为连接节点i和j的管道中的流量，如果水从i流向j，则为正，如果流向相反，则为负。摩擦水头损失和管道中的流量之间的关系可以表示为
$$
h_{L i j}=r q_{i j}\left|q_{i j}\right|^{n-1}+m q_{i j}\left|q_{i j}\right|\tag{1.1}
$$
其中$h_{Lij}$是水头损耗，$r$是电阻系数，$n$是流量指数，$m$是小损耗系数。阻力系数的值将取决于使用哪种摩擦头损失公式（见表3.1）。对于节点i和j之间的泵，水头损耗（水头增益的负值）可以用以下形式表示
$$
h_{L i j}=-\omega^{2}\left(h_{0}-r\left(q_{i j} / \omega\right)^{n}\right)\tag{1.2}
$$
其中h0是泵的关断头，𝜔是相对速度设置，r和n是泵的曲线系数，$q_{ij}$被要求是正的。
跨越节点i和j之间的管道的能量守恒要求
$$
h_{i}-h_{j}=h_{L i j}\left(q_{i j}\right)\tag{1.3}
$$
其中$h_i$和$h_j$分别是每个节点的水力压头。
节点i的质量守恒要求总流入量等于总流出量。
$$
\sum_{j} q_{i j}-D_{i}=0\tag{1.4}
$$
其中，总和是在所有与节点i相连的节点j上进行的，按照惯例，流入一个节点的流量是正的。$D_i$为节点i需要交付的已知需求流。对于固定等级节点上的一组已知头，我们为每个节点上的头h和每个环节上的流量q寻求一个解决方案，以满足公式(1.3)，(1.4)。

EPANET使用Todini全局梯度算法（GGA）（Todini and Pilati, 1988）来解决这个方程组。GGA在一个迭代的Newton-Raphson方案中使用守恒方程的线性化，导致每个迭代的两步解决程序。第一步解决节点头的（N×N）稀疏线性方程组，第二步对每个环节应用一个标度器更新公式来计算其新流量。Todini和Rossman（2013）提供了GGA的完整推导，并讨论了它比其他网络解决方法的优势。

该算法从每个环节的流量的初始估计开始，不一定满足流量的连续性。在每个迭代中，通过解决一组h的线性方程来找到新的节点头。
$$
\boldsymbol{A} \boldsymbol{h}=\boldsymbol{F}\tag{1.5}
$$
其中A是一个（N×N）方形对称系数矩阵，h是一个（N×1）未知结点头的向量，F是一个（N×1）右手边项的向量。系数矩阵的对角线元素为：
$$
A_{i i}=\sum_{j} \frac{1}{g_{i j}}\tag{1.6}
$$
而非零的非对角线项是：
$$
A_{i j}=A_{j i}=-\frac{1}{g_{i j}}\tag{1.7}
$$
其中$g_{ij}$是节点i和j之间的链接中的水头损失相对于流量的梯度（一阶导数）。对于管道:
$$
g_{i j}=n r\left|q_{i j}\right|^{n-1}+\frac{\partial r}{\partial q_{i j}}\left|q_{i j}\right|^{n}+2 m\left|q_{i j}\right|\tag{1.8}
$$
而对于泵
$$
g_{i j}=n \omega^{2} r\left(q_{i j} / \omega\right)^{n-1}\tag{1.9}
$$
每个右手边项Fi由节点i的净流量不平衡加上一个流量校正因子组成。
$$
F_{i}=\sum_{j}\left(q_{i j}+h_{L i j} / g_{i j}\right)-D_{i}+\sum_{f} H_{f} / g_{i f}\tag{1.10}
$$
其中最后一项适用于已知头$H_f$，连接节点i和固定等级节点f的任何链接。在通过求解公式计算出新的头之后。(1.5)，在节点i和j之间的每个链接中找到新的流量。
$$
q_{i j}=q_{i j}-\Delta q_{i j}\tag{1.11}
$$
其中
$$
\Delta q_{i j}=\left(h_{L i j}-h_{i}+h_{j}\right) / g_{i j}\tag{1.12}
$$
GGA的一个有趣的特点是，流量更新公式在第一次迭代后总是保持每个节点周围的流量连续性。迭代继续进行，直到满足一些基于与质量和能量守恒方程相关的残余误差的适当**收敛准则**，或者流量的变化变得可以忽略不计。
> 收敛准则
> EPANET可以使用几个不同的标准来确定GGA的迭代何时趋于可接受的水力解决方案。
> 1. 所有流量变化的总和除以所有链接（包括真实和虚拟）中所有流量的总和，必须小于规定的ACCURACY值。
> $$
> \frac{\sum|\Delta q|}{\sum|q|}<\text { ACCURACY }\tag{1.13}
> $$
> 2. 满足能量平衡方程(1.3）的每个环节（不包括封闭环节和活动PRVs/PSVs）必须小于指定的水头公差。
> 3. 所有链接（包括真实和虚拟）中最大的流量变化必须小于指定的流量容忍度。

### 1.2 延时模拟的动态模型
延长周期模拟（EPS）可以被添加到静态网络水力模型中，方法是为每个水箱节点加入一个方程，说明由于它收到的净流量而导致体积随时间的变化。
$$
\frac{d V_{s}}{d t}=Q_{s, n e t}\tag{1.14}
$$
其中$V_s$是储存在水箱s中的体积，t是时间，$Q_{s,net}$是流入（或流出）水箱的净流量。还需要第二个方程，将水箱高程水头Hs（即其水面高程）与体积联系起来。
$$
H_{s}=E_{s}+Y\left(V_{s}\right)\tag{1.15}
$$
其中$E_s$是水箱的底部海拔，$Y(V)$是水箱的深度与体积函数（取决于水箱的几何形状）。
在GGA中，在时间t存在的水箱水位H(t)和节点需求被用来解决静态网络守恒方程，从而产生一组新的净流量进入每个水箱$Q_{net}(t)$。然后，上述方程被用来确定一段时间后∆t的新油箱水平。然后在时间t+∆t内运行一个新的静态分析，使用新的油箱水平以及适用于这个新时间段的任何新需求和操作条件。仿真以这种方式从一个时间段到下一个时间段进行。

## 2. 基于卡尔曼滤波的预测方法
**使用卡尔曼滤波的方法具有计算速度快、效率高、预警及时，并且无需大量数据进行训练等优点。**

由于来自真实DMA的径向流量和压力测量值遵循一个典型的日间变化，每天有两个周期性的峰值：一个在早餐时间05:00-08:00左右，一个在晚上00:00-4:00左右。因此，卡尔曼滤波公式中表示的模型可能不适合，因为这些时间相邻的数据点之间预期的变化很快。然而，如果我们认为最后一个状态是前一周（天）的同一时间，而不是时间序列样本中的最后一个数据，即最后15分钟，那么目前的线性模型是合理的。[2-5]使用的模型和基本卡尔曼滤波公式如下：
* 系统的动态方程
将第k-1步和第k步的状态量之间的差异看作是符合高斯分布的噪声，在卡尔曼滤波第k步时，在已知高斯白噪声Q的前提下，流量的状态量$x$可通过线性差分方程来表示：
$$
x(k) = x(k-1)+Q\tag{2.1}
$$
* 观测方程
考虑到流量计和数据上传的误差，将由设备造成的不确定性看作符合高斯分布的噪声R，流量（压力）的观测量$z$可通过下述方程表示：
$$
z(k) = x(k)+R\tag{2.2}
$$
在第k步时，将公式(1)中的状态预测量记为$x(k|k-1)$，将滤波器的估计值记为$x(k|k),q(k)$和$r(k)$是Q和R的协方差，滤波器进行流量预测时按照以下五个步骤进行：
(1) 预估流量值  
$$x(k \mid k-1)=x(k-1 \mid k-1)\tag{2.3}$$
(2) 预估流量协方差
$$p(k \mid k-1)=p(k-1 \mid k-1)+q(k)\tag{2.4}$$
(3) 计算卡尔曼增益 $K$
$$K=p(k \mid k-1)[p(k \mid k-1)+r(k)]^{-1}\tag{2.5}$$
(4) 更新流量预测值
$$x(k \mid k)=  x(k \mid k-1)+K[z(k)-x(k \mid k-1)]\tag{2.6}$$
(5) 更新流量协方差
$$
p(k \mid k)=(1-K) p(k \mid k-1)\tag{2.7}
$$

[2-5]是使用的自适应卡尔曼滤波，[2]除了预测流量外还预测了压力，并将二者结合一起做漏损检测：
$$P(k)=\exp \left[-\frac{\left(R_{f}-R_{p}\right)^{2}}{\sigma\left|R_{f} R_{p}\right|}\right]$$
$p(k)$的范围是0到1，代表发生漏损的概率。$R_f$和$R_p$是流量和压力的归一化残差，$\sigma$是一个正数，取决于系统。但是这种组合并不能提高检测效果。这是因为缺乏关于压力敏感性的先验信息。根据文中的实验结果作者还指出，**流量测量比压力测量与突发事件的关系更密切**，但仍然很难量化它们的关系。这些数据需要根据表记位置和地点的具体情况进行仔细解释。

[6]构建带有泄漏量的动态方程（4个输入变量；12个状态变量包括4个节点处的压力，4个节点处的输入输出流量一共有6个，2个中间节点的泄漏量，具体的动态方程文中未提），提出了用非线性EKF做漏损的检测定位。[7]使用加速度传感器在管道外侧测量加速度来进行漏损检测（当出现漏损时管道内部压力骤降，外部振动会变强），文章提出使用分布式卡尔曼滤波可以减小误报率，提高漏损检测的准确度。[8]为进一步提高爆管时段爆管检出成功率，对 Ye 的方法进行改进，通过对卡尔曼滤波残差进行累积和运算，使爆管信号叠加、放大， 进而提高爆管检测成功率。此外，通过设置较大的爆管检测限降低非爆管时段误报率。

**国内将卡尔曼滤波用在供水管网爆管预警的文献较少，根据查阅的结果来看做这方面工作的有昆明理工大学建筑工程学院、大连理工大学水文学及水资源专业。我们可以利用自己专业优势在信息融合方面做更深入的探讨。**

## 参考文献
[1] [epanet22-manual-latest](https://epanet22.readthedocs.io/_/downloads/en/latest/pdf/)
[2] Kalman Filtering of Hydraulic Measurements for Burst Detection in Water Distribution Systems [J]. 2011.
[3] 闫涛. 自适应卡尔曼滤波在供水管网爆管信号识别的研究 [D]; 昆明理工大学, 2019.
[4] 顾建强. 供水管网漏损评估与控制研究分析 [D]; 大连理工大学, 2020.
[5] 闫涛, 杜坤, 李贤胜, et al. 自适应卡尔曼滤波在供水管网爆管预警的应用 [J]. 重庆大学学报, 2019, 42(08): 99-106.
[6] Majidi Khalilabad N, Mollazadeh M, Akbarpour A, et al. LEAK DETECTION IN WATER DISTRIBUTION SYSTEM USING NON-LINEAR KALMAN FILTER [J]. IUST, 2018, 8(2): 169-80.
[7] Nkemeni V, Mieyeville F, Tsafack P. A Distributed Computing Solution Based on Distributed Kalman Filter for Leak Detection in WSN-Based Water Pipeline Monitoring [J]. Sensors, 2020, 20(18): 5204.
[8] 马琪然, 杜坤, 周明, et al. 基于改进卡尔曼滤波的供水管网爆管检测研究 [J]. 中国给水排水, 2019, 35(17): 69-73.